# Function App Deployment Template
# Handles slot deployment, swap, and management for Azure Functions

parameters:
  - name: azureSubscription
    type: string
  - name: appName
    type: string
  - name: slotName
    type: string
    default: 'staging'
  - name: artifactName
    type: string
  - name: resourceGroup
    type: string
  - name: packagePath
    type: string
    default: '$(Pipeline.Workspace)/**/*.zip'
  - name: runtimeStack
    type: string
    default: 'PYTHON|3.12'

steps:
  - task: DownloadBuildArtifacts@1
    displayName: 'Download artifact: ${{ parameters.artifactName }}'
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: '${{ parameters.artifactName }}'
      downloadPath: '$(Pipeline.Workspace)'

  # Display artifact contents for debugging
  - task: PowerShell@2
    displayName: 'List artifact contents'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "##[section]Artifact contents:"
        Get-ChildItem -Path "$(Pipeline.Workspace)/${{ parameters.artifactName }}" -Recurse

  - task: AzureAppServiceManage@0
    displayName: 'Start deployment slot: ${{ parameters.slotName }}'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      action: 'Start Azure App Service'
      webAppName: '${{ parameters.appName }}'
      resourceGroupName: '${{ parameters.resourceGroup }}'
      specifySlotOrASE: true
      slot: '${{ parameters.slotName }}'

  - task: AzureFunctionApp@2
    displayName: 'Deploy to slot: ${{ parameters.slotName }}'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      appType: 'functionAppLinux'
      appName: '${{ parameters.appName }}'
      deployToSlotOrASE: true
      resourceGroupName: '${{ parameters.resourceGroup }}'
      slotName: '${{ parameters.slotName }}'
      package: '${{ parameters.packagePath }}'
      runtimeStack: '${{ parameters.runtimeStack }}'

  - task: AzureAppServiceManage@0
    displayName: 'Swap slots: ${{ parameters.slotName }} -> production'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      action: 'Swap Slots'
      webAppName: '${{ parameters.appName }}'
      resourceGroupName: '${{ parameters.resourceGroup }}'
      sourceSlot: '${{ parameters.slotName }}'
      swapWithProduction: true

  - task: AzureAppServiceManage@0
    displayName: 'Stop deployment slot: ${{ parameters.slotName }}'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      action: 'Stop Azure App Service'
      webAppName: '${{ parameters.appName }}'
      resourceGroupName: '${{ parameters.resourceGroup }}'
      specifySlotOrASE: true
      slot: '${{ parameters.slotName }}'
