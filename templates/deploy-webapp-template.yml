# Web App Deployment Template
# Handles slot deployment, swap, and management for Azure App Service

parameters:
  - name: azureSubscription
    type: string
  - name: appName
    type: string
  - name: slotName
    type: string
    default: 'staging'
  - name: artifactName
    type: string
  - name: packagePath
    type: string
    default: '$(Pipeline.Workspace)/**/*.zip'
  - name: runtimeStack
    type: string
    default: 'PYTHON|3.12'
  - name: startUpCommand
    type: string
    default: 'bash startup.sh'

steps:
  - task: DownloadBuildArtifacts@1
    displayName: 'Download artifact: ${{ parameters.artifactName }}'
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: '${{ parameters.artifactName }}'
      downloadPath: '$(Pipeline.Workspace)'

  - task: AzureAppServiceManage@0
    displayName: 'Start deployment slot: ${{ parameters.slotName }}'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      action: 'Start Slot'
      webAppName: '${{ parameters.appName }}'
      resourceGroupName: '$(resourceGroup)'
      specifySlotOrASE: true
      slot: '${{ parameters.slotName }}'

  - task: AzureWebApp@1
    displayName: 'Deploy to slot: ${{ parameters.slotName }}'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      appType: 'webAppLinux'
      appName: '${{ parameters.appName }}'
      deployToSlotOrASE: true
      resourceGroupName: '$(resourceGroup)'
      slotName: '${{ parameters.slotName }}'
      package: '${{ parameters.packagePath }}'
      runtimeStack: '${{ parameters.runtimeStack }}'
      startUpCommand: '${{ parameters.startUpCommand }}'

  - task: AzureAppServiceManage@0
    displayName: 'Swap slots: ${{ parameters.slotName }} -> production'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      action: 'Swap Slots'
      webAppName: '${{ parameters.appName }}'
      resourceGroupName: '$(resourceGroup)'
      sourceSlot: '${{ parameters.slotName }}'
      swapWithProduction: true

  - task: AzureAppServiceManage@0
    displayName: 'Stop deployment slot: ${{ parameters.slotName }}'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      action: 'Stop Slot'
      webAppName: '${{ parameters.appName }}'
      resourceGroupName: '$(resourceGroup)'
      specifySlotOrASE: true
      slot: '${{ parameters.slotName }}'
