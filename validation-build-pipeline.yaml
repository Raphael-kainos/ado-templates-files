# Lightweight build template for PR validation
# No versioning, no tagging, no deployment - just validate the build

parameters:
  - name: pythonVersion
    type: string
    default: '4.0'
  - name: workingDirectory
    type: string
  - name: artifactName
    type: string

steps:
  - checkout: self
    fetchDepth: 1  # Shallow clone for speed
  
  - task: UsePythonVersion@0
    displayName: 'Use Python ${{ parameters.pythonVersion }}'
    inputs:
      versionSpec: '${{ parameters.pythonVersion }}'
      addToPath: true

  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install dependencies'
    workingDirectory: '${{ parameters.workingDirectory }}'

  # Run linting - blocks PR if critical errors found
  - script: |
      pip install pylint flake8
      flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    displayName: 'Run linting'
    workingDirectory: '${{ parameters.workingDirectory }}'

  # Run tests - blocks PR if tests fail
  - script: |
      pip install pytest pytest-cov
      pytest --junitxml=junit/test-results.xml --cov=. --cov-report=xml
    displayName: 'Run tests'
    workingDirectory: '${{ parameters.workingDirectory }}'

  - task: ArchiveFiles@2
    displayName: 'Archive application files'
    inputs:
      rootFolderOrFile: '${{ parameters.workingDirectory }}'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/${{ parameters.artifactName }}.zip'
      replaceExistingArchive: true